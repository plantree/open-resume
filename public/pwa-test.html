<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWAæµ‹è¯• - OpenResume</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .status-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .status-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ OpenResume PWAåŠŸèƒ½æµ‹è¯•</h1>
    
    <h2>ğŸ“‹ PWAåŠŸèƒ½æ£€æµ‹</h2>
    <div id="manifest-status" class="status-item">æ­£åœ¨æ£€æµ‹Manifestæ–‡ä»¶...</div>
    <div id="sw-status" class="status-item">æ­£åœ¨æ£€æµ‹Service Worker...</div>
    <div id="install-status" class="status-item">æ­£åœ¨æ£€æµ‹å®‰è£…åŠŸèƒ½...</div>
    <div id="offline-status" class="status-item">æ­£åœ¨æ£€æµ‹ç¦»çº¿åŠŸèƒ½...</div>
    
    <h2>ğŸ”§ PWAæ“ä½œ</h2>
    <button id="install-btn" class="hidden">å®‰è£…PWAåº”ç”¨</button>
    <button id="sw-update-btn">æ›´æ–°Service Worker</button>
    <button id="test-offline-btn">æµ‹è¯•ç¦»çº¿åŠŸèƒ½</button>
    
    <h2>ğŸ“Š æŠ€æœ¯ä¿¡æ¯</h2>
    <div id="tech-info">
        <p><strong>ç”¨æˆ·ä»£ç†:</strong> <span id="user-agent"></span></p>
        <p><strong>æ”¯æŒService Worker:</strong> <span id="sw-support"></span></p>
        <p><strong>æ”¯æŒWeb App Manifest:</strong> <span id="manifest-support"></span></p>
        <p><strong>æ˜¾ç¤ºæ¨¡å¼:</strong> <span id="display-mode"></span></p>
        <p><strong>ç½‘ç»œçŠ¶æ€:</strong> <span id="network-status"></span></p>
    </div>
    
    <h2>ğŸ”— å¿«é€Ÿé“¾æ¥</h2>
    <p>
        <a href="/">è¿”å›ä¸»é¡µ</a> |
        <a href="/resume-builder">åˆ›å»ºç®€å†</a> |
        <a href="/resume-import">å¯¼å…¥ç®€å†</a> |
        <a href="/manifest.json" target="_blank">æŸ¥çœ‹Manifest</a>
    </p>

    <script>
        let deferredPrompt;
        
        // æ£€æµ‹åŠŸèƒ½æ”¯æŒ
        function checkSupport() {
            // Service Workeræ”¯æŒ
            const swSupport = 'serviceWorker' in navigator;
            document.getElementById('sw-support').textContent = swSupport ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            
            // Manifestæ”¯æŒ  
            const manifestSupport = 'serviceWorker' in navigator;
            document.getElementById('manifest-support').textContent = manifestSupport ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            
            // ç”¨æˆ·ä»£ç†
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            // æ˜¾ç¤ºæ¨¡å¼
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'Standalone (PWA)' : 'Browser';
            document.getElementById('display-mode').textContent = displayMode;
            
            // ç½‘ç»œçŠ¶æ€
            updateNetworkStatus();
        }
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€
        function updateNetworkStatus() {
            const status = navigator.onLine ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
            document.getElementById('network-status').textContent = status;
        }
        
        // æ£€æµ‹Manifest
        async function checkManifest() {
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    document.getElementById('manifest-status').className = 'status-item status-success';
                    document.getElementById('manifest-status').textContent = 
                        `âœ… Manifestæ–‡ä»¶åŠ è½½æˆåŠŸ: ${manifest.name}`;
                } else {
                    throw new Error('æ— æ³•åŠ è½½Manifest');
                }
            } catch (error) {
                document.getElementById('manifest-status').className = 'status-item status-error';
                document.getElementById('manifest-status').textContent = `âŒ Manifestæ£€æµ‹å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ£€æµ‹Service Worker
        async function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        document.getElementById('sw-status').className = 'status-item status-success';
                        document.getElementById('sw-status').textContent = 
                            `âœ… Service Workerå·²æ³¨å†Œ: ${registration.scope}`;
                    } else {
                        // å°è¯•æ³¨å†Œ
                        const newRegistration = await navigator.serviceWorker.register('/sw.js');
                        document.getElementById('sw-status').className = 'status-item status-success';
                        document.getElementById('sw-status').textContent = 
                            `âœ… Service Workeræ³¨å†ŒæˆåŠŸ: ${newRegistration.scope}`;
                    }
                } catch (error) {
                    document.getElementById('sw-status').className = 'status-item status-error';
                    document.getElementById('sw-status').textContent = 
                        `âŒ Service Workeræ£€æµ‹å¤±è´¥: ${error.message}`;
                }
            } else {
                document.getElementById('sw-status').className = 'status-item status-error';
                document.getElementById('sw-status').textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker';
            }
        }
        
        // æ£€æµ‹å®‰è£…åŠŸèƒ½
        function checkInstallability() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('install-status').className = 'status-item status-success';
                document.getElementById('install-status').textContent = 'âœ… åº”ç”¨å·²å®‰è£…å¹¶åœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹è¿è¡Œ';
            } else if (deferredPrompt) {
                document.getElementById('install-status').className = 'status-item status-warning';
                document.getElementById('install-status').textContent = 'âš ï¸ åº”ç”¨å¯ä»¥å®‰è£…';
                document.getElementById('install-btn').classList.remove('hidden');
            } else {
                document.getElementById('install-status').className = 'status-item status-warning';
                document.getElementById('install-status').textContent = 'âš ï¸ ç­‰å¾…å®‰è£…æç¤ºæˆ–ä¸æ”¯æŒå®‰è£…';
            }
        }
        
        // æ£€æµ‹ç¦»çº¿åŠŸèƒ½
        function checkOffline() {
            if (navigator.onLine) {
                document.getElementById('offline-status').className = 'status-item status-success';
                document.getElementById('offline-status').textContent = 'âœ… å½“å‰åœ¨çº¿ï¼ŒService Workerå°†ç¼“å­˜èµ„æº';
            } else {
                document.getElementById('offline-status').className = 'status-item status-warning';
                document.getElementById('offline-status').textContent = 'âš ï¸ å½“å‰ç¦»çº¿ï¼Œæ­£åœ¨ä½¿ç”¨ç¼“å­˜èµ„æº';
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            checkInstallability();
        });
        
        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            checkInstallability();
        });
        
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`å®‰è£…ç»“æœ: ${outcome}`);
                deferredPrompt = null;
                checkInstallability();
            }
        });
        
        document.getElementById('sw-update-btn').addEventListener('click', async () => {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    registration.update();
                    alert('Service Workeræ›´æ–°è¯·æ±‚å·²å‘é€');
                }
            }
        });
        
        document.getElementById('test-offline-btn').addEventListener('click', () => {
            window.open('/offline', '_blank');
        });
        
        // åˆå§‹åŒ–æ£€æµ‹
        document.addEventListener('DOMContentLoaded', () => {
            checkSupport();
            checkManifest();
            checkServiceWorker();
            checkInstallability();
            checkOffline();
        });
    </script>
</body>
</html>
